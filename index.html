<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Private Space</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen" class="app-container">
        <div class="header"><h1>Welcome ‚ù§Ô∏è</h1></div>
        <div class="login-form">
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <button id="login-btn">Enter</button>
        </div>
    </div>

    <div id="chat-screen" class="app-container" style="display: none;">
        <div class="header">
            <span>Our Chat</span>
            <button id="logout-btn">Exit</button>
        </div>
        <div id="typing-indicator" style="font-size: 12px; color: gray; height: 15px; padding-left: 20px;"></div>
        <div id="chat-window" class="chat-window"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Message...">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // REPLACE THIS WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBgvYFXA4kwXSOgInvRdzwgfF48zPHfatA",
            authDomain: "ourmessenger-2f308.firebaseapp.com",
            projectId: "ourmessenger-2f308",
            storageBucket: "ourmessenger-2f308.firebasestorage.app",
            messagingSenderId: "898949597150",
            appId: "1:898949597150:web:e97136cf7f6660b43abf4f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Elements
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const chatWindow = document.getElementById('chat-window');
        const input = document.getElementById('message-input');

        // --- AUTH LOGIC ---
        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (e) { alert("Login failed!"); }
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                chatScreen.style.display = 'flex';
                loadMessages();
            } else {
                loginScreen.style.display = 'flex';
                chatScreen.style.display = 'none';
            }
        });

        // --- CHAT LOGIC ---
        document.getElementById('send-btn').onclick = sendMessage;
        input.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    async function sendMessage() {
        if (input.value.trim() !== "") {

            await addDoc(collection(db, "messages"), {
                text: input.value,
                sender: auth.currentUser.email,
                createdAt: serverTimestamp(),
                seen: false
            });

        // üîΩ ADD THIS RIGHT HERE (reset typing status after sending)
        await setDoc(doc(db, "status", auth.currentUser.uid), {
            isTyping: false,
            email: auth.currentUser.email
        });

        input.value = "";
    }
}

        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                chatWindow.innerHTML = "";
            snapshot.forEach((doc) => {
            const data = doc.data();
            const isMe = data.sender === auth.currentUser.email;
            
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'my-message' : 'partner-message'}`;
            
            // Add the text + a tiny "Seen" label if it's your message and it's been read
            let seenStatus = (isMe && data.seen) ? '<span style="display:block; font-size:10px; opacity:0.5;">Seen</span>' : '';
            div.innerHTML = `${data.text} ${seenStatus}`;
            
            chatWindow.appendChild(div);
        });

            // Trigger the "Mark as Seen" function whenever new messages arrive
            markMessagesAsSeen();
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }

        import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const typingIndicator = document.getElementById('typing-indicator');

        // 1. TELL THE DATABASE YOU ARE TYPING
        input.addEventListener('input', () => {
            // We create a special document in a "status" collection for each user
            setDoc(doc(db, "status", auth.currentUser.uid), {
                isTyping: input.value.length > 0,
                email: auth.currentUser.email
            });
        });

        // 2. LISTEN FOR YOUR PARTNER TYPING
        onSnapshot(collection(db, "status"), (snapshot) => {
            snapshot.forEach((doc) => {
                const data = doc.data();
                // If it's not me and they ARE typing
                if (data.email !== auth.currentUser.email && data.isTyping) {
                    typingIndicator.innerText = "Partner is typing...";
                } else if (data.email !== auth.currentUser.email && !data.isTyping) {
                    typingIndicator.innerText = "";
                }
            });
        });

    
    </script>
</body>
</html>