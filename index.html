<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Private Space</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OurMessenger">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0084ff">
</head>
<body>

    <div id="login-screen" class="app-container">
        <div class="login-container">
            <div class="login-header">
                <h1 class="login-title">OurMessenger</h1>
                <div class="login-icon">‚ù§Ô∏è</div>
                <p class="login-subtitle">A private space just for us.</p>
            </div>
            
            <div class="login-form">
                <input type="email" id="login-email" placeholder="Email address">
                <input type="password" id="login-pass" placeholder="Password">
                <button id="login-btn">Log In</button>
            </div>
            
            <div class="login-footer">
                <span>Locked & Private</span>
            </div>
        </div>
    </div>

    <div id="chat-screen" class="app-container" style="display: none;">
        <div class="header">
            <span>OurMessenger</span>
            <div>
                <input type="file" id="image-upload" accept="image/*" style="display: none;">
                <button id="theme-btn">üñºÔ∏è</button>
                <button id="logout-btn">Exit</button>
            </div>
        </div>
        <div id="typing-indicator" style="font-size: 12px; color: gray; height: 15px; padding-left: 20px;"></div>
        <div id="chat-window" class="chat-window"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Message...">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script type="module">
        // Add this at the top of your script
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!'))
                    .catch(err => console.log('Service Worker failed:', err));
            });
}
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
            serverTimestamp, doc, setDoc, getDocs, where, updateDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgvYFXA4kwXSOgInvRdzwgfF48zPHfatA",
            authDomain: "ourmessenger-2f308.firebaseapp.com",
            projectId: "ourmessenger-2f308",
            storageBucket: "ourmessenger-2f308.firebasestorage.app",
            messagingSenderId: "898949597150",
            appId: "1:898949597150:web:e97136cf7f6660b43abf4f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const chatWindow = document.getElementById('chat-window');
        const input = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator');

        // --- LOGIN ---
        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try { 
                await signInWithEmailAndPassword(auth, email, pass); 
            } catch (e) { 
                alert("Login failed!"); 
            }
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                chatScreen.style.display = 'flex';
                loadMessages();
                setupTypingListener();
            } else {
                loginScreen.style.display = 'flex';
                chatScreen.style.display = 'none';
            }
        });

        // --- CHAT LOGIC ---
        async function markMessagesAsSeen() {
            if (!auth.currentUser) return;
            const q = query(collection(db, "messages"), where("sender", "!=", auth.currentUser.email), where("seen", "==", false));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(async (d) => { await updateDoc(doc(db, "messages", d.id), { seen: true }); });
        }

        document.getElementById('send-btn').onclick = sendMessage;
        input.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

        async function sendMessage() {
            const text = input.value.trim();
            if (text !== "") {
                await addDoc(collection(db, "messages"), {
                    text: text, sender: auth.currentUser.email, createdAt: serverTimestamp(), seen: false
                });
                await setDoc(doc(db, "status", auth.currentUser.uid), { isTyping: false, email: auth.currentUser.email });
                input.value = "";
            }
        }

        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                chatWindow.innerHTML = "";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = data.sender === auth.currentUser.email;
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'my-message' : 'partner-message'}`;
                    let seenStatus = (isMe && data.seen) ? '<span style="display:block; font-size:10px; opacity:0.5;">Seen</span>' : '';
                    div.innerHTML = `${data.text} ${seenStatus}`;
                    chatWindow.appendChild(div);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
                markMessagesAsSeen();
            });
        }

        // --- TYPING ---
        input.addEventListener('input', () => {
            if (auth.currentUser) {
                setDoc(doc(db, "status", auth.currentUser.uid), { isTyping: input.value.length > 0, email: auth.currentUser.email });
            }
        });

        function setupTypingListener() {
            onSnapshot(collection(db, "status"), (snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.email !== auth.currentUser.email) {
                        typingIndicator.innerText = data.isTyping ? "Partner is typing..." : "";
                    }
                });
            });
        }

        // --- PHOTO THEME LOGIC (BASE64) ---
        const themeBtn = document.getElementById('theme-btn');
        const fileInput = document.getElementById('image-upload');

        // Listen for cloud changes
        onSnapshot(doc(db, "settings", "wallpaper"), (docSnap) => {
            if (docSnap.exists()) {
                const imageUrl = docSnap.data().backgroundUrl;
                chatWindow.style.backgroundImage = `url('${imageUrl}')`;
            }
        });

        // Trigger file picker
        themeBtn.onclick = () => fileInput.click();

        // Convert image to Base64 and save to Firestore
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Firestore document limit is 1MB
            if (file.size > 800000) { 
                alert("File too large. Please choose a photo smaller than 800KB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64String = event.target.result;
                try {
                    await setDoc(doc(db, "settings", "wallpaper"), {
                        backgroundUrl: base64String
                    });
                } catch (error) {
                    console.error("Theme save failed:", error);
                }
            };
            reader.readAsDataURL(file);
        };
    </script>
</body>
</html>